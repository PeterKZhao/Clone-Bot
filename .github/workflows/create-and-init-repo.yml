name: Create and init repo from Gitee

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "要创建的新 GitHub 仓库名（例如: ruoyi-vue-pro）"
        required: true
        default: "ruoyi-vue-pro"
      repo_description:
        description: "仓库描述"
        required: false
        default: "Init from Gitee ruoyi-vue-pro master-jdk17"
      private:
        description: "是否创建为私有仓库 (true/false)"
        required: false
        default: "false"

jobs:
  create-and-init:
    runs-on: ubuntu-latest

    steps:
      - name: Create new GitHub repo via REST API
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NEW_REPO: ${{ github.event.inputs.repo_name }}
          REPO_DESC: ${{ github.event.inputs.repo_description }}
          PRIVATE: ${{ github.event.inputs.private }}
        run: |
          echo "Creating repo: ${NEW_REPO}"

          # 把 true/false 字符串转成 JSON 里的布尔值
          if [ "${PRIVATE}" = "true" ]; then
            PRIVATE_BOOL=true
          else
            PRIVATE_BOOL=false
          fi

          curl -sS \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/user/repos \
            -d "{
              \"name\": \"${NEW_REPO}\",
              \"description\": \"${REPO_DESC}\",
              \"private\": ${PRIVATE_BOOL}
            }"

      - name: Clone from Gitee and prepare repo
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NEW_REPO: ${{ github.event.inputs.repo_name }}
        run: |
          # 1. 从 Gitee 克隆 master-jdk17 分支
          git clone -b master-jdk17 --single-branch https://gitee.com/zhijiantianya/ruoyi-vue-pro.git source

          cd source

          # 2. 删除不需要的内容（保留 sql）
          rm -rf .git .gitee .github .image Readme.md

          # 3. 调用项目内的 Python 脚本做全局替换（假设在 tools/replace_all.py）
          #    脚本里请把 target_directory 写成 "."，不要写本地盘符路径
          if [ -f "tools/replace_all.py" ]; then
            python tools/replace_all.py
          else
            echo "⚠️ 未找到 tools/replace_all.py，跳过替换步骤"
          fi

          # 4. 重新初始化 Git 仓库
          git init
          git config user.name "github-actions[bot]"
          git config user.email "[email protected]"
          git add .
          git commit -m "Initial commit: 梦开始的地方"

          # 5. 关联刚创建的 GitHub 新仓库，并推送到 master
          git branch -M master
          git remote add origin https://x-access-token:${GH_PAT}@github.com/PeterKZhao/${NEW_REPO}.git
          git push -u origin master
