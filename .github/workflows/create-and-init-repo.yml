name: Create and init repo

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "要创建的新 GitHub 仓库名（例如: future-vue-pro）"
        required: true
        default: "future-vue-pro"
      repo_description:
        description: "仓库描述"
        required: false
        default: "Init from Gitee ruoyi-vue-pro master-jdk17"
      private:
        description: "是否创建为私有仓库 (true/false)"
        required: false
        default: "false"

jobs:
  create-and-init:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      GH_PAT: ${{ secrets.GH_PAT }}
      OWNER: PeterKZhao
      NEW_REPO: ${{ github.event.inputs.repo_name }}
      REPO_DESC: ${{ github.event.inputs.repo_description }}
      PRIVATE: ${{ github.event.inputs.private }}

    steps:
      - name: Checkout Clone-Bot
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: pip install -q -r tools/requirements.txt

      - name: Delete existing repo if exists
        shell: bash
        run: |
          set -euo pipefail
          CODE="$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${NEW_REPO}")"

          if [ "${CODE}" = "200" ]; then
            curl -sS -o /dev/null -X DELETE \
              -H "Authorization: Bearer ${GH_PAT}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${OWNER}/${NEW_REPO}"
            sleep 3
          fi

      - name: Clone, process and prepare repo content
        shell: bash
        run: |
          set -euo pipefail

          git clone -q -b master-jdk17 --depth=1 --single-branch \
            https://github.com/YunaiV/ruoyi-vue-pro.git source

          rm -rf source/.git source/.gitee source/.github source/.image \
                 source/Readme.md source/yudao-ui source/sql

          (cd source && python3 ../tools/replace_all.py)
          (cd source && python3 ../tools/uncomment_maven.py)

          mkdir -p source/.github/workflows
          if [ ! -f "templates/workflows/maven.yml" ]; then
            exit 1
          fi
          cp -f templates/workflows/maven.yml source/.github/workflows/maven.yml

          mkdir -p repo_content
          cp -a source/. repo_content/
          rm -rf source

          (cd repo_content && python3 ../tools/restructure_layout.py)
          (cd repo_content && python3 ../tools/split_api_biz.py)
          (cd repo_content && python3 ../tools/patch_application_local.py)

      - name: Create new GitHub repo
        shell: bash
        run: |
          set -euo pipefail

          PRIVATE_BOOL=$( [ "${PRIVATE}" = "true" ] && echo true || echo false )

          RESP="$(curl -sS \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/user/repos \
            -d "{
              \"name\": \"${NEW_REPO}\",
              \"description\": \"${REPO_DESC}\",
              \"private\": ${PRIVATE_BOOL}
            }")"

          if ! echo "${RESP}" | grep -q '"full_name"'; then
            exit 1
          fi

          sleep 3

          curl -sS -o /dev/null -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${OWNER}/${NEW_REPO}" \
            -d '{"security_and_analysis":{"secret_scanning":{"status":"enabled"},"secret_scanning_push_protection":{"status":"disabled"}}}' \
            || true

      - name: Push to new repo
        shell: bash
        run: |
          set -euo pipefail
          cd repo_content
          git init -q
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -q -m "Initial commit: 梦开始的地方"
          git branch -M master
          git remote add origin "https://x-access-token:${GH_PAT}@github.com/${OWNER}/${NEW_REPO}.git"
          git push -q -u origin master

      - name: Copy secrets to new repository
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_KEY: ${{ secrets.SSH_KEY }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: python3 tools/copy_secrets.py

      - name: Write job summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" << EOF
          ## ✅ 仓库初始化完成
          | 项目 | 内容 |
          |------|------|
          | 仓库名称 | \`${NEW_REPO}\` |
          | 仓库地址 | https://github.com/${OWNER}/${NEW_REPO} |
          | Secrets | 已复制 8 个配置项 |
          EOF
