name: Create and init repo from Gitee

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "要创建的新 GitHub 仓库名（例如: future-vue-pro）"
        required: true
        default: "future-vue-pro"
      repo_description:
        description: "仓库描述"
        required: false
        default: "Init from Gitee ruoyi-vue-pro master-jdk17"
      private:
        description: "是否创建为私有仓库 (true/false)"
        required: false
        default: "false"

jobs:
  create-and-init:
    runs-on: ubuntu-latest

    steps:
      - name: Clone and prepare
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # 1. 从 Gitee 克隆 master-jdk17 分支
          git clone -b master-jdk17 --single-branch https://gitee.com/zhijiantianya/ruoyi-vue-pro.git source
          cd source

          # 2. 删除不需要的内容（保留 sql）
          rm -rf .git .gitee .github .image Readme.md

          cd ..

          # 3. 克隆你的模板仓库（用 PAT 认证）
          git clone https://x-access-token:${GH_PAT}@github.com/PeterKZhao/Clone-Bot.git template

          # 4. 记录 source 的绝对路径，传给脚本
          SOURCE_PATH=$(pwd)/source
          echo "SOURCE_PATH=$SOURCE_PATH" > source_path.txt

          # 5. 在 source 目录下执行脚本（脚本会读取 SOURCE_PATH 环境变量）
          cd source
          python ../template/tools/replace_all.py

          # 6. 脚本结束后，找到新的目录名
          cd ..
          NEW_DIR=$(ls -d future* 2>/dev/null | head -n 1 || echo "source")
          echo "使用目录: $NEW_DIR"
          echo "$NEW_DIR" > repo_dir_name.txt

      - name: Create new GitHub repo via REST API
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NEW_REPO: ${{ github.event.inputs.repo_name }}
          REPO_DESC: ${{ github.event.inputs.repo_description }}
          PRIVATE: ${{ github.event.inputs.private }}
        run: |
          echo "Creating repo: ${NEW_REPO}"

          if [ "${PRIVATE}" = "true" ]; then
            PRIVATE_BOOL=true
          else
            PRIVATE_BOOL=false
          fi

          curl -sS \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/user/repos \
            -d "{
              \"name\": \"${NEW_REPO}\",
              \"description\": \"${REPO_DESC}\",
              \"private\": ${PRIVATE_BOOL}
            }"

      - name: Init git and push to new repo
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NEW_REPO: ${{ github.event.inputs.repo_name }}
        run: |
          # 读取目录名
          REPO_DIR=$(cat repo_dir_name.txt)
          echo "进入目录: $REPO_DIR"
          cd "$REPO_DIR"

          git init
          git config user.name "github-actions[bot]"
          git config user.email "[email protected]"
          git add .
          git commit -m "Initial commit: 梦开始的地方"

          git branch -M master
          git remote add origin https://x-access-token:${GH_PAT}@github.com/PeterKZhao/${NEW_REPO}.git
          git push -u origin master
