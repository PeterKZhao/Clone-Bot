name: Create and init repo from Gitee

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "è¦åˆ›å»ºçš„æ–° GitHub ä»“åº“åï¼ˆä¾‹å¦‚: future-vue-proï¼‰"
        required: true
        default: "future-vue-pro"
      repo_description:
        description: "ä»“åº“æè¿°"
        required: false
        default: "Init from Gitee ruoyi-vue-pro master-jdk17"
      private:
        description: "æ˜¯å¦åˆ›å»ºä¸ºç§æœ‰ä»“åº“ (true/false)"
        required: false
        default: "false"

jobs:
  create-and-init:
    runs-on: ubuntu-latest

    steps:
      - name: Delete existing repo if exists
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NEW_REPO: ${{ github.event.inputs.repo_name }}
        run: |
          echo "æ£€æŸ¥å¹¶åˆ é™¤å·²æœ‰ä»“åº“: PeterKZhao/${NEW_REPO}"
          if curl -s -H "Authorization: Bearer ${GH_PAT}" \
                  -H "Accept: application/vnd.github+json" \
                  https://api.github.com/repos/PeterKZhao/${NEW_REPO} \
                  | grep -q '"full_name"'; then
            echo "ä»“åº“å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤..."
            curl -sS -X DELETE \
              -H "Authorization: Bearer ${GH_PAT}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/PeterKZhao/${NEW_REPO}
            echo "âœ… æ—§ä»“åº“å·²åˆ é™¤"
            sleep 2
          else
            echo "ä»“åº“ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"
          fi

      - name: Clone and prepare
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "ğŸ“¦ 1. å…‹éš† Gitee ä»“åº“..."
          git clone -b master-jdk17 --single-branch https://gitee.com/zhijiantianya/ruoyi-vue-pro.git source
          
          echo "ğŸ§¹ 2. æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶..."
          cd source
          rm -rf .git .gitee .github .image Readme.md
          cd ..

          echo "ğŸ“¥ 3. å…‹éš†æ¨¡æ¿ä»“åº“..."
          git clone https://x-access-token:${GH_PAT}@github.com/PeterKZhao/Clone-Bot.git template

          echo "ğŸ”„ 4. æ‰§è¡Œæ›¿æ¢è„šæœ¬..."
          cd source
          python ../template/tools/replace_all.py
          cd ..

          echo "ğŸ“„ 4.1 å¤åˆ¶ maven workflowï¼ˆè‡ªåŠ¨å®šä½ï¼‰..."
          mkdir -p source/.github/workflows
          MAVEN_FILE="$(find template -maxdepth 6 -type f \( -name 'maven.yml' -o -name 'maven.yaml' \) | head -n 1)"
          if [ -z "${MAVEN_FILE}" ]; then
            echo "âŒ åœ¨ template ä¸­æœªæ‰¾åˆ° maven.yml / maven.yamlï¼›è¯·ç¡®è®¤ Clone-Bot ä»“åº“é‡Œè¯¥æ–‡ä»¶å®é™…è·¯å¾„"
            exit 1
          fi
          cp -f "${MAVEN_FILE}" source/.github/workflows/maven.yml

          echo "ğŸ“ 5. å‡†å¤‡æœ€ç»ˆç›®å½•..."
          # åˆ›å»ºæœ€ç»ˆä¸Šä¼ ç›®å½•
          mkdir -p repo_content
          
          # å°† source çš„æ‰€æœ‰å†…å®¹ç§»åŠ¨åˆ° repo_content
          mv source/* repo_content/ 2>/dev/null || true
          mv source/.* repo_content/ 2>/dev/null || true
          
          # åˆ é™¤ç©ºçš„ source å’Œ template ç›®å½•
          rm -rf source template
          
          echo "âœ… å‡†å¤‡å®Œæˆï¼Œæœ€ç»ˆç›®å½•å†…å®¹ï¼š"
          ls -la repo_content/

      - name: Create new GitHub repo and disable push protection
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NEW_REPO: ${{ github.event.inputs.repo_name }}
          REPO_DESC: ${{ github.event.inputs.repo_description }}
          PRIVATE: ${{ github.event.inputs.private }}
        run: |
          echo "ğŸš€ åˆ›å»ºæ–°ä»“åº“: ${NEW_REPO}"

          if [ "${PRIVATE}" = "true" ]; then
            PRIVATE_BOOL=true
          else
            PRIVATE_BOOL=false
          fi

          curl -sS \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/user/repos \
            -d "{
              \"name\": \"${NEW_REPO}\",
              \"description\": \"${REPO_DESC}\",
              \"private\": ${PRIVATE_BOOL}
            }"

          echo "â³ ç­‰å¾…ä»“åº“åˆ›å»º..."
          sleep 3

          echo "ğŸ”“ ç¦ç”¨ Push Protection..."
          curl -sS \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/PeterKZhao/${NEW_REPO} \
            -d '{"security_and_analysis": {"secret_scanning": {"status": "enabled"}, "secret_scanning_push_protection": {"status": "disabled"}}}'

          echo "âœ… ä»“åº“åˆ›å»ºå®Œæˆ"

      - name: Init git and push to new repo
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          NEW_REPO: ${{ github.event.inputs.repo_name }}
        run: |
          echo "ğŸ“¤ æ¨é€åˆ°æ–°ä»“åº“..."
          cd repo_content

          git init
          git config user.name "github-actions[bot]"
          git config user.email "[email protected]"
          
          git add .
          git commit -m "Initial commit: æ¢¦å¼€å§‹çš„åœ°æ–¹"

          git branch -M master
          git remote add origin https://x-access-token:${GH_PAT}@github.com/PeterKZhao/${NEW_REPO}.git
          git push -u origin master

          echo "ğŸ‰ æ¨é€å®Œæˆï¼"
          echo "ğŸ”— ä»“åº“åœ°å€: https://github.com/PeterKZhao/${NEW_REPO}"
