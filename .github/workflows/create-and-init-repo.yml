name: Create and init repo

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "è¦åˆ›å»ºçš„æ–° GitHub ä»“åº“åï¼ˆä¾‹å¦‚: future-vue-proï¼‰"
        required: true
        default: "future-vue-pro"
      repo_description:
        description: "ä»“åº“æè¿°"
        required: false
        default: "Init from Gitee ruoyi-vue-pro master-jdk17"
      private:
        description: "æ˜¯å¦åˆ›å»ºä¸ºç§æœ‰ä»“åº“ (true/false)"
        required: false
        default: "false"

jobs:
  create-and-init:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Clone-Bot
        uses: actions/checkout@v4

      - name: Delete existing repo if exists
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          OWNER: PeterKZhao
          NEW_REPO: ${{ github.event.inputs.repo_name }}
        shell: bash
        run: |
          set -euo pipefail

          echo "æ£€æŸ¥å¹¶åˆ é™¤å·²æœ‰ä»“åº“: ${OWNER}/${NEW_REPO}"
          CODE="$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${OWNER}/${NEW_REPO}")"

          if [ "${CODE}" = "200" ]; then
            echo "ä»“åº“å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤..."
            curl -sS -X DELETE \
              -H "Authorization: Bearer ${GH_PAT}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${OWNER}/${NEW_REPO}"
            echo "âœ… æ—§ä»“åº“å·²åˆ é™¤"
            sleep 3
          else
            echo "ä»“åº“ä¸å­˜åœ¨ï¼ˆHTTP ${CODE}ï¼‰ï¼Œæ— éœ€åˆ é™¤"
          fi

      - name: Clone upstream and prepare content
        env:
          OWNER: PeterKZhao
          NEW_REPO: ${{ github.event.inputs.repo_name }}
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ“¦ 1. å…‹éš†ä¸Šæ¸¸ä»“åº“..."
          git clone -b master-jdk17 --single-branch https://github.com/YunaiV/ruoyi-vue-pro.git source

          echo "ğŸ§¹ 2. æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶..."
          rm -rf source/.git source/.gitee source/.github source/.image source/Readme.md source/ruoyi-ui || true

          echo "ğŸ”„ 3. æ‰§è¡Œæ›¿æ¢è„šæœ¬..."
          (cd source && python3 ../tools/replace_all.py)

          echo "ğŸ”„ 4. è§£é™¤æ³¨é‡Šï¼ˆå†…ç½® IoT é»‘åå•é€»è¾‘ï¼Œä»¥ä½ çš„ uncomment_maven.py ä¸ºå‡†ï¼‰..."
          (cd source && python3 ../tools/uncomment_maven.py)

          echo "ğŸ“„ 5. å¤åˆ¶ Maven workflow åˆ°æ–°ä»“åº“..."
          mkdir -p source/.github/workflows
          if [ ! -f "templates/workflows/maven.yml" ]; then
            echo "âŒ æœªæ‰¾åˆ° templates/workflows/maven.ymlï¼ˆè¯·æŠŠ maven.yml æ”¾åˆ°è¯¥è·¯å¾„ï¼‰"
            exit 1
          fi
          cp -f templates/workflows/maven.yml source/.github/workflows/maven.yml

          echo "ğŸ“ 6. å‡†å¤‡æœ€ç»ˆç›®å½• repo_content..."
          mkdir -p repo_content
          cp -a source/. repo_content/
          rm -rf source

          echo "âœ… å‡†å¤‡å®Œæˆï¼Œæœ€ç»ˆç›®å½•å†…å®¹ï¼š"
          ls -la repo_content/

      - name: Restructure project layout
        shell: bash
        run: |
          set -euo pipefail
          (cd repo_content && python3 ../tools/restructure_layout.py)

      - name: Create new GitHub repo (and try disable push protection)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          OWNER: PeterKZhao
          NEW_REPO: ${{ github.event.inputs.repo_name }}
          REPO_DESC: ${{ github.event.inputs.repo_description }}
          PRIVATE: ${{ github.event.inputs.private }}
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸš€ åˆ›å»ºæ–°ä»“åº“: ${NEW_REPO}"

          if [ "${PRIVATE}" = "true" ]; then
            PRIVATE_BOOL=true
          else
            PRIVATE_BOOL=false
          fi

          RESP="$(curl -sS \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/user/repos \
            -d "{
              \"name\": \"${NEW_REPO}\",
              \"description\": \"${REPO_DESC}\",
              \"private\": ${PRIVATE_BOOL}
            }")"

          echo "${RESP}" | head -c 500 || true
          echo

          if ! echo "${RESP}" | grep -q "\"full_name\""; then
            echo "âŒ åˆ›å»ºä»“åº“å¤±è´¥ï¼ˆå“åº”ä¸­æœªåŒ…å« full_nameï¼‰"
            exit 1
          fi

          echo "â³ ç­‰å¾…ä»“åº“åˆ›å»º..."
          sleep 3

          echo "ğŸ”“ å°è¯•ç¦ç”¨ Push Protectionï¼ˆå¤±è´¥ä¸é˜»æ–­æµç¨‹ï¼‰..."
          curl -sS -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${OWNER}/${NEW_REPO}" \
            -d '{"security_and_analysis": {"secret_scanning": {"status": "enabled"}, "secret_scanning_push_protection": {"status": "disabled"}}}' \
            || true

          echo "âœ… ä»“åº“åˆ›å»ºå®Œæˆ: https://github.com/${OWNER}/${NEW_REPO}"

      - name: Init git and push to new repo
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          OWNER: PeterKZhao
          NEW_REPO: ${{ github.event.inputs.repo_name }}
        shell: bash
        run: |
          set -euo pipefail

          echo "ğŸ“¤ æ¨é€åˆ°æ–°ä»“åº“..."
          cd repo_content

          git init
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "Initial commit: æ¢¦å¼€å§‹çš„åœ°æ–¹"

          git branch -M master
          git remote add origin "https://x-access-token:${GH_PAT}@github.com/${OWNER}/${NEW_REPO}.git"
          git push -u origin master

          echo "ğŸ‰ æ¨é€å®Œæˆï¼"
          echo "ğŸ”— ä»“åº“åœ°å€: https://github.com/${OWNER}/${NEW_REPO}"
