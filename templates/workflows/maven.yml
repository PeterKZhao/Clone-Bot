deploy:
  needs: build
  runs-on: ubuntu-latest
  steps:
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: future-server-jar
        path: dist

    - name: Copy JAR to server
      uses: appleboy/scp-action@v1
      with:
        host: ${{ secrets.SSH_HOST }}
        port: ${{ secrets.SSH_PORT }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: "dist/future-server.jar"
        target: "/usr/local/myapp"
        strip_components: 1
        overwrite: true

    - name: Deploy with Docker Compose
      uses: appleboy/ssh-action@v1
      env:
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_USERNAME: ${{ secrets.DB_USERNAME }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        REDIS_HOST: ${{ secrets.REDIS_HOST }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      with:
        host: ${{ secrets.SSH_HOST }}
        port: ${{ secrets.SSH_PORT }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        envs: DB_HOST,DB_USERNAME,DB_PASSWORD,REDIS_HOST,REDIS_PASSWORD
        script: |
          set -e
          cd /usr/local/myapp
          
          echo "ðŸ“¦ éªŒè¯æ–‡ä»¶..."
          ls -lh future-server.jar
          
          echo "ðŸ”§ æ›´æ–° .env æ–‡ä»¶..."
          cat > .env << EOF
          DB_HOST=${DB_HOST}
          DB_USERNAME=${DB_USERNAME}
          DB_PASSWORD=${DB_PASSWORD}
          REDIS_HOST=${REDIS_HOST}
          REDIS_PASSWORD=${REDIS_PASSWORD}
          EOF
          
          echo "ðŸ—ï¸  æž„å»ºé•œåƒï¼ˆå¦‚æžœéœ€è¦ï¼‰..."
          docker-compose build
          
          echo "ðŸ”„ é‡å¯æœåŠ¡..."
          docker-compose down
          docker-compose up -d
          
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          echo "âœ… æœåŠ¡çŠ¶æ€ï¼š"
          docker-compose ps
          
          echo "ðŸ“‹ åº”ç”¨æ—¥å¿—ï¼š"
          docker-compose logs --tail 30 my-app
          
          echo "ðŸ¥ å¥åº·æ£€æŸ¥ï¼š"
          docker-compose exec -T my-app curl -s http://localhost:48080/actuator/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"
